name: Notificar Nova Release (API v1)

on:
  release:
    # --- MODIFICADO AQUI ---
    # O gatilho 'released' cobre a publica√ß√£o de uma nova release
    # e tamb√©m a edi√ß√£o de uma pr√©-release para se tornar a "latest".
    types: [released]

jobs:
  notificar:
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Autenticar com Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}'

      - name: 'Obter Token de Acesso'
        id: get_access_token
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: 'Enviar Notifica√ß√£o de Nova Vers√£o'
        run: |
          # --- ADICIONADO PASSO PARA GARANTIR QUE N√ÉO √â UMA PR√â-RELEASE ---
          # Esta verifica√ß√£o impede que a notifica√ß√£o seja enviada para pr√©-releases.
          if [ "${{ github.event.release.prerelease }}" = "false" ]; then
            curl -X POST \
              -H "Authorization: Bearer ${{ steps.get_access_token.outputs.access_token }}" \
              -H "Content-Type: application/json" \
              -d '{
                "message": {
                  "topic": "all",
                  "notification": {
                    "title": "Nova atualiza√ß√£o do Zenith WMS! üöÄ",
                    "body": "A vers√£o ${{ github.event.release.tag_name }} est√° dispon√≠vel."
                  },
                  "data": {
                    "version": "${{ github.event.release.tag_name }}"
                  }
                }
              }' \
              https://fcm.googleapis.com/v1/projects/SEU_ID_DE_PROJETO_AQUI/messages:send
          else
            echo "Release √© uma pr√©-release. Nenhuma notifica√ß√£o enviada."
          fi
